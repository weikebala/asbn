$(function(){if(typeof bNoSupportDesign!="undefined"){$(".ds-nav-ct").remove();$("#main-container").empty().html('<div class="no-support">\n        <p>很抱歉，您当前使用的浏览器不支持在线设计工具，请升级或者更换您的浏览器。<br />如果您有别的浏览器，请复制当前链接到其他浏览器。可以使用Firefox、Safari、Chrome或IE10浏览器!</p>\n        <p>当前页面链接：udz.com/_design</p>\n        <p></p>\n    </div>');return false}if(sType!="1"&&sType!="2"&&sType!="3"){sType="0"}localStorage.setItem("CurrentDesignType",sType);var q={get:function(v){try{return localStorage.getItem(v)}catch(w){return""}},set:function(v,x){try{localStorage.setItem(v,x);return true}catch(w){return false}}};var g=$("#clothing-designer");var r={boundingBoxColor:"#f60","x":200,"y":160,"width":300,"height":400};var l=g.fancyProductDesigner({selectedColor:"#d5d5d5",boundingBoxColor:"#80AFEF",outOfBoundaryColor:"#990000",boundingBoxWeight:2,boundingBoxBorder:2,editorMode:false,fonts:["Arial","Fearless","Helvetica","alien","bay","bells","blazed","bells","cubic","bells","glass","jaw","mmd","upd","simsun","Carme","黑体","opensans-semibold","permanentmarker","creampuff","distantgalaxy","lindenhill","bebas","wasabi","russian","college","Bradley Hand Bold","Chalkduster","Comic Sans MS Bold","Comic Sans MS","Courier New","Herculanum","Trebuchet MS"],customTextParameters:{scale:1,degree:0,colors:"#000000",removable:true,resizable:true,draggable:true,rotatable:true,autoCenter:true,autoSelect:true,boundingBoxClipping:true,curved:false,curvable:true,curveReverse:false,zChangeable:true,editable:true,topped:false,opacity:1,patternable:false},customImagesParameters:{draggable:true,rotatable:true,resizable:true,removable:true,autoCenter:true,boundingBoxClipping:true,autoSelect:true,zChangeable:true},textParameters:{scale:1,degree:0,colors:"#000000",removable:true,resizable:true,draggable:true,rotatable:true,autoCenter:true,autoSelect:true,boundingBoxClipping:true,curved:false,curvable:true,curveReverse:false,zChangeable:true,editable:true,topped:false,opacity:1,patternable:true},elementParameters:{}}).data("fancy-product-designer");$("#btnDynamicAddProduct").on("click",function(){var y=[];var v={title:"自定义产品",thumbnail:"${imageUploadPath}/designer/images/sweater/preview.png",elements:[]};for(var x=0;x<2;x++){var w={type:x==1?"text":"image",source:x==1?"source_"+x.toString():"${imageUploadPath}/designer/images/sweater/basic.png",title:"Base",parameters:x==1?{colors:"#000000",zChangeable:true,removable:true,draggable:true,resizable:true,rotatable:true,autoCenter:true,boundingBox:"title_0",scale:2}:{"x":314,"y":323,"colors":"#98937f, #000000, #ffffff"}};v.elements.push(w)}y.push(v);l.addProduct(y)});$("#btnDynamicAddDesign").on("click",function(){l.addDesign("${imageUploadPath}/designer/images/designs/swirl.png","自定义设计",{"zChangeable":true,"x":215,"y":200,"colors":"#000000","removable":true,"draggable":true,"rotatable":true,"resizable":true,"autoCenter":true},"all","${imageUploadPath}/designer/images/designs/swirl.png")});var c;$("#btnDynamicAddTxt").on("click",function(){l.addElement("text","aaa","bbb",{colors:"#ff6600,#aaaaaa",removable:true,resizable:true,draggable:true,rotatable:true,autoCenter:true,curved:false,curvable:true,curveReverse:false,zChangeable:true,editable:true,textDecoration:"line-through",autoSelect:true,topped:false,opacity:1,patternable:false})});$("#btnDynamicAddLine").on("click",function(){l.alterValue(c,"textDecoration","line-through")});var d=function(v){$.ajax({url:"_calculateForprice",type:"get",data:v,dataType:"json"}).done(function(w){if(w.code==200){$("#thsirt-price").text(w.data)}else{}}).fail(function(w){})};var m=[];var j={aDesignImgsBase64:[],aFullImgsBase64:[]};var n=[];var a=[];g.on("ready",function(E,G){$(".operate-area").on("mouseenter",".txt",function(){var H=$(this);if(H.data("target")!="designs"){H.parent().children(".fpd-designs").hide()}H.parent().children(".fpd-"+H.data("target")).show()}).on("mouseleave",".txt",function(){var H=$(this);if(H.data("target")!="designs"){H.parent().children(".fpd-"+H.data("target")).hide()}}).on("mouseenter",".ct",function(){var H=$(this);H.show()}).on("mouseleave",".ct",function(){var H=$(this);if(H.hasClass("fpd-designs")==false){H.hide()}});$(".close-design").on("click",function(){$(".fpd-designs").hide()});var x=$("#form");x.on("submit",function(){return false});$(".fpd-menu-bar").remove();$(".fpd-fb-user-photos").remove();$(".fpd-instagram-photos").remove();$("[data-target='.fpd-fb-user-photos']").remove();$("[data-target='.fpd-instagram-photos']").remove();var z=g.data("design-page");if(z.totalPage>1){var B=function(H){$.ajax({url:"_getDesignImageLib",type:"get",cache:false,data:z,dataType:"json"}).done(function(M){if(M.code==200){F.html(z.currentPage+" / "+z.totalPage);D.children("picture").remove();for(var K=0;K<M.data.length;K++){var I={"colors":"","imgcolors":"","removable":true,"draggable":true,"rotatable":true,"resizable":true,"zChangeable":true,"boundingBoxClipping":true,"autoCenter":true,"autoSelect":true,"scale":0.5,"imgid":""};var N=M.data[K];var J=[];var L="#000000";if(N.colors){if(N.colors.length==1){J=[];L=N.colors[0]}else{J=N.colors;L=false}}I.imgid=N.id.toString();I.imgname=N.name.toString();I.colors=L;I.imgcolors=J;l.addDesign(GlobalConfigUrl.corurl+"/"+N.url,N.name,I,"all",GlobalConfigUrl.corurl+"/"+N.url)}}}).fail(function(I){})};var v=$(".fpd-items-page");var D=v.prev();var w=v.children(".page-prev").on("click",function(){if(z.currentPage==1){return false}z.currentPage-=1;B()});var y=v.children(".page-next").on("click",function(){if(z.currentPage==z.totalPage){return false}z.currentPage+=1;B()});var F=v.children(".page-ct");F.html(z.currentPage+" / "+z.totalPage)}(function(){var N=[];var L=$("picture[data-category]");for(var K=0;K<L.length;K++){N.push(L.eq(K))}var P=$(".fpd-product-picture-container").find(".fpd-products .fpd-items-wrapper");var O=_.groupBy(N,function(Q){return Q.data("category")});var I=$('<select class="">');for(var M in O){var J=$('<div class="groupby none" data-target="'+M+'">');_.forEach(O[M],function(Q){J.append(Q)});I.append('<option value="'+M+'">'+M+"</option>");P.append(J)}var H=$('<div class="divselect">');H.prepend(I);P.prepend(H);I.on("change",function(){var Q=$(this);Q.parent().siblings().hide().filter("[data-target="+Q.val()+"]").show()}).trigger("change")})();var C=q.get("CurrentProduct"+sVerision);if(C){try{C=JSON.parse(C)}catch(A){return false}window.setTimeout(function(){var H=l.getMyProductElementsByTitle("衣服",C)[0];FPDGlobalVariable.sClothingstyle=H.parameters.clothingstyle;FPDGlobalVariable.sClothingname=H.parameters.clothingname;FPDGlobalVariable.sStyleonly=H.parameters.styleonly;FPDGlobalVariable.sStylereject=H.parameters.stylereject;l.setColorArea(H.parameters.diycolors);l.reloadProduct(C)},500);return false}}).on("productCreate",function(v,w){if(b===true&&k!=null&&t!=null){j={aDesignImgsBase64:[],aFullImgsBase64:[]};setTimeout(function(){var x=l.getViewsDataURL("png","transparent",1.8);for(var y=0;y<x.length;y++){j.aDesignImgsBase64.push(x[y])}k=null;b=false;t=null;FPDGlobalVariable.bProductLoaded=true;q.set("CurrentImgsBase64",JSON.stringify(j));e(i);location.href="_setgoal"},1000)}if(b===false){FPDGlobalVariable.bProductLoaded=true;g.trigger("priceChange",[0,0,"productCreate"])}if(FPDGlobalVariable.bFirst===true){FPDGlobalVariable.bFirst=false}}).on("priceChange",function(C,x,y,A){if(FPDGlobalVariable.bProductLoaded===true){var w=o();if(FPDGlobalVariable.sClothingstyle=="pl"&&FPDGlobalVariable.sClothingname.indexOf("(绣花")>-1){var z=JSLINQ(FPDGlobalVariable.aCustomerDesignElements[0]).Where(function(F){return F.parameters.photo=="1"}).ToArray();if(z.length>0||w.nFrontColorNums>1){layer.msg("POLO衫正面颜色数超过1种，请减少颜色数",4,{type:8,shade:false});return false}else{var D=JSLINQ(FPDGlobalVariable.aCustomerDesignElements[1]).Where(function(F){return F.parameters.photo=="1"}).ToArray();if(D.length>0||w.nBackColorNums>1){layer.msg("POLO衫背面颜色数超过1种，请减少颜色数",4,{type:8,shade:false});return false}}}var E=h();var B=f(w,E);var v=l.getMyProductElementsByTitle("衣服",FPDGlobalVariable.aProduct)[0];d({sex:v.parameters.clothingsex,style:v.parameters.clothingstyle,clothescount:50,colorcount:B,type:sType,technology:E});if(E=="shuma"){$.layer({title:"友情提示",dialog:{msg:"您的设计由于颜色复杂，网站将采用数码印刷方式，数码印刷的特点是墨水柔和同时透气，但明亮度和饱和度会有所减弱。<br />如果您确认可以继续，否则请修改设计！<br />",type:-1}})}}}).on("elementAdded",function(v,w){FPDGlobalVariable.aProduct=l.getProductNoVerify(false);l.selectElement(w);l.getElementsColor();g.trigger("priceChange",[0,0,"elementAdded"])}).on("elementRemove",function(v,w){FPDGlobalVariable.aProduct=l.getProductNoVerify(false);l.getElementsColor();g.trigger("priceChange",[0,0,"elementRemove"]);q.set("CurrentProduct"+sVerision,JSON.stringify(FPDGlobalVariable.aProduct))}).on("elementSelect",function(v,w){});var h=function(){if(FPDGlobalVariable.sClothingname.indexOf("(绣花")>-1){return"xiuhua"}else{for(var v=0;v<FPDGlobalVariable.aCustomerDesignElements[0].length;v++){if(FPDGlobalVariable.aCustomerDesignElements[0][v].parameters.photo==1){return"shuma"}}for(v=0;v<FPDGlobalVariable.aCustomerDesignElements[1].length;v++){if(FPDGlobalVariable.aCustomerDesignElements[1][v].parameters.photo==1){return"shuma"}}var w=o();if(w.nColorNums>12){return"shuma"}else{return"siwang"}}};var f=function(v,x){var w=v.nColorNums;if(x=="shuma"){if(v.nFrontColorNums>0&&v.nBackColorNums>0){w=2}else{w=1}}return w};var o=function(){var v=[];var w=[];Array.prototype.push.apply(v,FPDGlobalVariable.aCustomerElementsColor[0]);Array.prototype.push.apply(v,FPDGlobalVariable.aCustomerImageColor[0]);Array.prototype.push.apply(w,FPDGlobalVariable.aCustomerElementsColor[1]);Array.prototype.push.apply(w,FPDGlobalVariable.aCustomerImageColor[1]);v=JSLINQ(v).Distinct(function(x){return x}).ToArray();w=JSLINQ(w).Distinct(function(x){return x}).ToArray();return{nColorNums:v.length+w.length,nFrontColorNums:v.length,nBackColorNums:w.length,aFrontColor:v,aBackColor:w}};var u=function(v,y){var x=$("<form />").attr(v).appendTo(document.body);for(var w in y){x.append("<input name='"+w+"' value='"+y[w]+"' />")}x.submit();x.remove()};var e=function(x){var w=JSLINQ(x[0].elements).Where(function(A){return A.parameters&&A.parameters.imgid&&A.parameters.imgid.indexOf("uploads/")>-1&&A.parameters.imgid.indexOf(".")>-1}).Select(function(A){return A.parameters.imgid}).ToArray();Array.prototype.push.apply(w,JSLINQ(x[1].elements).Where(function(A){return A.parameters&&A.parameters.imgid&&A.parameters.imgid.indexOf("uploads/")>-1&&A.parameters.imgid.indexOf(".")>-1}).Select(function(A){return A.parameters.imgid}).ToArray());q.set("CurrentCustomerUploadImg",JSON.stringify(w));try{localStorage.setItem("CurrentProduct"+sVerision,JSON.stringify(x))}catch(y){for(var v=0;v<x[0].elements.length;v++){var z=x[0].elements[v];if(z.parameters&&z.parameters.imgid&&z.parameters.imgid.indexOf("uploads/")>-1&&z.parameters.imgid.indexOf(".")>-1){x[0].elements.splice(v,1);v-=1}}for(v=0;v<x[1].elements.length;v++){var z=x[1].elements[v];if(z.parameters&&z.parameters.imgid&&z.parameters.imgid.indexOf("uploads/")>-1&&z.parameters.imgid.indexOf(".")>-1){x[1].elements.splice(v,1);v-=1}}try{localStorage.setItem("CurrentProduct"+sVerision,JSON.stringify(x))}catch(y){return false}}};var b=false;var k=null;var t=null;var i=null;$("#submit-pc-design-design").on("click",function(D){var y=o();if(y.nColorNums<=0){layer.msg("请添加一个设计",2,{type:8,shade:false});return false}var C=l.getProduct(false);if(FPDGlobalVariable.sClothingstyle=="pl"&&FPDGlobalVariable.sClothingname.indexOf("(绣花")>-1){var A=JSLINQ(FPDGlobalVariable.aCustomerDesignElements[0]).Where(function(G){return G.parameters.photo=="1"}).ToArray();if(A.length>0||y.nFrontColorNums>1){layer.msg("POLO衫正面颜色数超过1种<br />请减少颜色数后再提交",4,{type:8,shade:false});return false}else{var E=JSLINQ(FPDGlobalVariable.aCustomerDesignElements[1]).Where(function(G){return G.parameters.photo=="1"}).ToArray();if(E.length>0||y.nBackColorNums>1){layer.msg("POLO衫背面颜色数超过1种<br />请减少颜色数后再提交",4,{type:8,shade:false});return false}}}else{for(var x=0;x<C[0].elements.length;x++){var z=C[0].elements[x];if(z.parameters&&z.parameters.imgid&&z.parameters.imgid.indexOf("uploads/")>-1&&z.parameters.imgid.indexOf(".")>-1){if(z.parameters.imgWidth*z.parameters.imgHeight<600000){layer.msg("图片像素太低，为了保证印刷质量，请按要求上传图片",4,{type:8,shade:false});return false}}}for(x=0;x<C[1].elements.length;x++){var z=C[1].elements[x];if(z.parameters&&z.parameters.imgid&&z.parameters.imgid.indexOf("uploads/")>-1&&z.parameters.imgid.indexOf(".")>-1){if(z.parameters.imgWidth*z.parameters.imgHeight<600000){layer.msg("图片像素太低，为了保证印刷质量，请按要求上传图片",4,{type:8,shade:false});return false}}}}q.set("CurrentDesignColor",JSON.stringify(y));q.set("CurrentClothingName",FPDGlobalVariable.sClothingname);var F=h();var B=f(y,F);if(F=="shuma"){for(var x=0;x<C[0].elements.length;x++){if(C[0].elements[x].title=="衣服"){if(C[0].elements[x].parameters.clothingstyle=="ckt"||C[0].elements[x].parameters.clothingstyle=="fxt"){layer.msg("此款设计颜色数较多，并不适合在这件衣服上设计",4,{type:8,shade:false});return false}var v=C[0].elements[x].parameters.diycolors.split(",");if(JSLINQ(aTintColor).Intersect(v).ToArray().length==0){layer.msg("此款设计颜色数较多，并不适合在这件衣服上设计",4,{type:8,shade:false});return false}}}}q.set("CurrentTechnologyType",h());q.set("CurrentTechnologyColorNum",f(y,F));layer.load("正在提交，请稍后...",0);FPDGlobalVariable.bProductLoaded=false;l.deselectElement();i=C;if(C===false){layer.alert("有错误");return false}var w=l.getProductCustomerElements(C);b=true;k=w;t=C;l.loadProduct(w);return false});var s=function(w){var v=l.getElementsByTitle("衣服");v.forEach(function(x){l.changeColor(x,w)})};var p=0;g.on("click",".clothing-color-item",function(){}).on("mouseenter",".clothing-color-item",function(){var v=$(this).data("color");clearTimeout(p);p=setTimeout(function(){s(v)},200)}).on("mouseleave",".clothing-color-item",function(){clearTimeout(p)});localStorage.removeItem("CurrentSelectItems")});